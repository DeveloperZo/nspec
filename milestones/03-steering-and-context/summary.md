# Milestone 03: Steering & Context — Summary

## Verification Results

| Method | Health Score | Questions/Checks | Gaps Found |
|--------|-------------|-----------------|------------|
| **Audit** (single-pass) | 91 / 100 | 25 deliverable checks | 3 gaps (0 medium, 3 low) |
| **CoVe** (chain of verification) | 92 / 100 | 25 evidence-based questions | 2 gaps (0 medium, 2 low) |
| **Committee** (synthesis) | **91 / 100** | Consensus of both reports | 0 medium, 2 low |

## What Was Built

| Deliverable | Files | Lines Added | Status |
|---|---|---|---|
| **A. Steering directory scanner** | `src/core/specStore.ts` | ~25 | Complete |
| **B. Setup steering command** | `src/core/specStore.ts`, `bin/nspec.mjs`, `src/extension.ts`, `src/specManager.ts`, `src/SpecPanelProvider.ts`, `package.json` | ~120 | Complete (CLI + extension) |
| **C. Workspace context injection** | `src/core/specStore.ts`, `bin/nspec.mjs`, `src/SpecPanelProvider.ts`, `src/specManager.ts` | ~150 | Complete |
| **D. AGENTS.md steering awareness** | `bin/nspec.mjs` | ~35 | Complete |

**Total new/modified**: ~330 lines across 6 files. TypeScript compiles with zero errors.

## Consensus Gaps (agreed by all methods)

| # | Gap | Severity | Fix Effort |
|---|---|---|---|
| **G1** | No automated tests for new functionality | LOW | New milestone scope |

## Minor Gaps (low severity, non-blocking)

| # | Gap | Note |
|---|---|---|
| G2 | `testing.md` not auto-generated by `setup-steering` | Hard to reliably infer test conventions; user creates manually |
| G3 | `findRelevantSourceFiles` matches on filename only | Plan specifies "fuzzy match on spec name vs filenames" — matches exactly |

## Success Criteria Status

| Criterion | Status |
|---|---|
| `.specs/steering/tech.md` content appears in every generated spec's system prompt | PASS |
| `nspec setup-steering` generates initial steering files from workspace | PASS (smoke-tested) |
| Design generation includes workspace context (visible in harness `_prompts/` output) | PASS (code-verified) |
| Design output references actual project dependencies/structure instead of generic suggestions | PASS (design-verified) |
| Steering files are additive — removing one doesn't break anything | PASS |

## Changes Made

### A. Steering Directory Scanner

**Before:** `loadSteering()` reads `_steering.md` (workspace) + `<name>/_steering.md` (spec)
**After:** Also scans `.specs/steering/*.md` alphabetically, prepended to steering context

Order: `steering/*.md` → `_steering.md` → `<name>/_steering.md`, separated by `\n\n---\n\n`

### B. Setup Steering Command

New CLI command `nspec setup-steering` and extension command `nspec.setupSteering`:
- Generates `product.md` from README + package.json description
- Generates `tech.md` from dependencies, build scripts, language detection
- Generates `structure.md` from top-level directory tree

### C. Workspace Context Injection

New `buildWorkspaceContext()` function in `core/specStore.ts` (pure Node, vscode-free):
- Reads package.json key fields (name, description, dependencies, scripts)
- Reads language config (tsconfig.json, pyproject.toml, Cargo.toml, *.csproj)
- Produces top-level directory listing (1 level deep, excludes node_modules etc.)
- Includes first 50 lines of up to 3 source files matching the spec name

**Guard:** Only injected for `design` and `tasks` stages — requirements stay user-intent-only.

### D. AGENTS.md Steering Awareness

Updated AGENTS.md template with:
- `steering/` directory in folder structure tree
- `setup-steering` command in CLI documentation
- Full "Steering Files" section: setup, what to include, when to update, how they work, workspace context injection

## Architecture

```
┌─────────────────────┐     ┌───────────────────┐
│  VS Code Extension  │     │  CLI (bin/)        │
│  specManager.        │     │  store.            │
│  buildWorkspaceCtx() │     │  buildWorkspaceCtx()│
│  setupSteering()     │     │  scaffoldSteering() │
└────────┬────────────┘     └────────┬──────────┘
         │                           │
    ┌────▼───────────────────────────▼────┐
    │         src/core/specStore.ts        │
    │                                      │
    │  loadSteering()    — scans steering/ │
    │  buildWorkspaceContext()   — NEW     │
    │  scaffoldSteering()       — NEW     │
    │                                      │
    │  Pure Node · No vscode · specsRoot  │
    └──────────────────────────────────────┘
```

## Conclusion

**Milestone 03 is complete and ready for use.** The final committee score of 91/100 reflects a solid implementation that closes both PARITY.md gaps: steering files for persistent project context (Section 7) and codebase awareness during generation (Section 4). All new code follows the M01 shared-core pattern — pure Node functions in `core/specStore.ts` consumed by both CLI and extension. Two low-severity gaps (no automated tests, testing.md not auto-generated) are non-blocking.
